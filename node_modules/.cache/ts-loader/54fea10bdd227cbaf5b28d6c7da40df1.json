{"remainingRequest":"/Users/dduru/VSCode/OmarzeUI/node_modules/babel-loader/lib/index.js!/Users/dduru/VSCode/OmarzeUI/node_modules/ts-loader/index.js??ref--13-2!/Users/dduru/VSCode/OmarzeUI/src/router/util/include/background/service-worker/index.ts","dependencies":[{"path":"/Users/dduru/VSCode/OmarzeUI/src/router/util/include/background/service-worker/index.ts","mtime":1596478761038},{"path":"/Users/dduru/VSCode/OmarzeUI/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/dduru/VSCode/OmarzeUI/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/dduru/VSCode/OmarzeUI/node_modules/ts-loader/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXktYnVmZmVyLnNsaWNlIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LnRvLXN0cmluZyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnJlZ2V4cC5leGVjIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLnJlcGVhdCI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5yZXBsYWNlIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMudHlwZWQtYXJyYXkudWludDgtYXJyYXkiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS5jb3B5LXdpdGhpbiI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnR5cGVkLWFycmF5LmV2ZXJ5IjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMudHlwZWQtYXJyYXkuZmlsbCI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnR5cGVkLWFycmF5LmZpbHRlciI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnR5cGVkLWFycmF5LmZpbmQiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS5maW5kLWluZGV4IjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMudHlwZWQtYXJyYXkuZm9yLWVhY2giOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS5pbmNsdWRlcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnR5cGVkLWFycmF5LmluZGV4LW9mIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMudHlwZWQtYXJyYXkuaXRlcmF0b3IiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS5qb2luIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMudHlwZWQtYXJyYXkubGFzdC1pbmRleC1vZiI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnR5cGVkLWFycmF5Lm1hcCI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnR5cGVkLWFycmF5LnJlZHVjZSI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnR5cGVkLWFycmF5LnJlZHVjZS1yaWdodCI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnR5cGVkLWFycmF5LnJldmVyc2UiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS5zZXQiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS5zbGljZSI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnR5cGVkLWFycmF5LnNvbWUiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS5zb3J0IjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMudHlwZWQtYXJyYXkuc3ViYXJyYXkiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS50by1sb2NhbGUtc3RyaW5nIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMudHlwZWQtYXJyYXkudG8tc3RyaW5nIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvd2ViLmRvbS1jb2xsZWN0aW9ucy5pdGVyYXRvciI7CmltcG9ydCB7IExvZywgV2ViLCBVdGlsIH0gZnJvbSAnQC9jb21wb25lbnRzL3V0aWwnOwppbXBvcnQgc2V0dXBTU0UgZnJvbSAnLi4vc3NlJzsKdmFyIGFwcGxpY2F0aW9uU2VydmVyUHVibGljS2V5ID0gcHJvY2Vzcy5lbnYuVlVFX0FQUF9WQVBJRF9QVUJfS0VZOwp2YXIgaXNTdWJzY3JpYmVkID0gZmFsc2U7CnZhciBzd1JlZ2lzdHJhdGlvbiA9IG51bGw7CgpmdW5jdGlvbiB1cmxCNjRUb1VpbnQ4QXJyYXkoYmFzZTY0U3RyaW5nKSB7CiAgdmFyIHBhZGRpbmcgPSAnPScucmVwZWF0KCg0IC0gYmFzZTY0U3RyaW5nLmxlbmd0aCAlIDQpICUgNCk7CiAgdmFyIGJhc2U2NCA9IChiYXNlNjRTdHJpbmcgKyBwYWRkaW5nKS5yZXBsYWNlKC9cLS9nLCAnKycpLnJlcGxhY2UoL18vZywgJy8nKTsKICB2YXIgcmF3RGF0YSA9IHdpbmRvdy5hdG9iKGJhc2U2NCk7CiAgdmFyIG91dHB1dEFycmF5ID0gbmV3IFVpbnQ4QXJyYXkocmF3RGF0YS5sZW5ndGgpOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IHJhd0RhdGEubGVuZ3RoOyArK2kpIHsKICAgIG91dHB1dEFycmF5W2ldID0gcmF3RGF0YS5jaGFyQ29kZUF0KGkpOwogIH0KCiAgcmV0dXJuIG91dHB1dEFycmF5Owp9CgpmdW5jdGlvbiBpbml0VXNlckludGVyZmFjZSgpIHsKICAvLyBTZXQgdGhlIGluaXRpYWwgc3Vic2NyaXB0aW9uIHZhbHVlCiAgc3dSZWdpc3RyYXRpb24ucHVzaE1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uKCkudGhlbihmdW5jdGlvbiAoc3Vic2NyaXB0aW9uKSB7CiAgICBpc1N1YnNjcmliZWQgPSAhKHN1YnNjcmlwdGlvbiA9PT0gbnVsbCk7CiAgICB1cGRhdGVTdWJzY3JpcHRpb25PblNlcnZlcihzdWJzY3JpcHRpb24pOwoKICAgIGlmIChpc1N1YnNjcmliZWQpIHsKICAgICAgTG9nLmluZm8oJ1VzZXIgSVMgc3Vic2NyaWJlZC4nKTsKICAgIH0gZWxzZSB7CiAgICAgIExvZy5pbmZvKCdVc2VyIElTIE5PVCBzdWJzY3JpYmVkLicpOwogICAgICBzdWJzY3JpYmVVc2VyKCk7CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIHN1YnNjcmliZVVzZXIoKSB7CiAgdmFyIGFwcGxpY2F0aW9uU2VydmVyS2V5ID0gdXJsQjY0VG9VaW50OEFycmF5KGFwcGxpY2F0aW9uU2VydmVyUHVibGljS2V5KTsKICBzd1JlZ2lzdHJhdGlvbi5wdXNoTWFuYWdlci5zdWJzY3JpYmUoewogICAgdXNlclZpc2libGVPbmx5OiB0cnVlLAogICAgYXBwbGljYXRpb25TZXJ2ZXJLZXk6IGFwcGxpY2F0aW9uU2VydmVyS2V5CiAgfSkudGhlbihmdW5jdGlvbiAoc3Vic2NyaXB0aW9uKSB7CiAgICBMb2cuaW5mbygnVXNlciBpcyBzdWJzY3JpYmVkLicpOwogICAgdXBkYXRlU3Vic2NyaXB0aW9uT25TZXJ2ZXIoc3Vic2NyaXB0aW9uKTsKICAgIGlzU3Vic2NyaWJlZCA9IHRydWU7CiAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycm9yKSB7CiAgICBMb2cuaW5mbygiRmFpbGVkIHRvIHN1YnNjcmliZSB0aGUgdXNlcjogIi5jb25jYXQoSlNPTi5zdHJpbmdpZnkoZXJyb3IpKSk7CiAgICBzZXR1cFNTRSgpOwogIH0pOwp9CgpmdW5jdGlvbiB1cGRhdGVTdWJzY3JpcHRpb25PblNlcnZlcihzdWJzY3JpcHRpb24pIHsKICAvLyBUT0RPOiBTZW5kIHN1YnNjcmlwdGlvbiB0byBhcHBsaWNhdGlvbiBzZXJ2ZXIKICBMb2cuaW5mbygiU3Vic2NyaXB0aW9uOiAiLmNvbmNhdChKU09OLnN0cmluZ2lmeShzdWJzY3JpcHRpb24pKSk7CiAgc3Vic2NyaXB0aW9uID0gVXRpbC5yZWZyZXNoKHN1YnNjcmlwdGlvbik7CgogIGlmIChzdWJzY3JpcHRpb24pIHsKICAgIExvZy5pbmZvKCdTdWJzY3JpcHRpb24gYXZhaWxhYmxlLiBDYWxsaW5nIFNlcnZlci4nKTsgLy8gVE9ETzogaGFuZGxlIGR1cGxpY2F0ZSBwb3N0aW5nIG9uIHNlcnZlciBzaWRlLgoKICAgIFdlYi5wb3N0KCcvYXBpL3YxL25vdGlmaWNhdGlvbl9zdWJzY3JpcHRpb24nLCB7CiAgICAgIGVuZHBvaW50OiBzdWJzY3JpcHRpb24uZW5kcG9pbnQsCiAgICAgIHB1YmxpY0tleTogc3Vic2NyaXB0aW9uLmtleXMucDI1NmRoLAogICAgICBhdXRoVG9rZW46IHN1YnNjcmlwdGlvbi5rZXlzLmF1dGgKICAgIH0sIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBMb2cuaW5mbygnU3Vic2NyaXB0aW9uIHN1Y2Nlc3NmdWxseSBwb3N0ZWQgdG8gc2VydmVyLicpOwogICAgfSwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgIExvZy5pbmZvKCdTdWJzY3JpcHRpb24gZmFpbGVkIG9uIHBvc3RpbmcgdG8gc2VydmVyLicpOwogICAgICBzZXR1cFNTRSgpOwogICAgfSk7CiAgfSBlbHNlIHsKICAgIExvZy5pbmZvKCdObyBzdWJzY3JpcHRpb24gYXZhaWxhYmxlJyk7CiAgICBzZXR1cFNTRSgpOwogIH0KfQoKZXhwb3J0IGRlZmF1bHQgKGZ1bmN0aW9uICgpIHsKICBMb2cuaW5mbygnU2VydmljZSBXb3JrZXIgYW5kIFB1c2ggaXMgc3VwcG9ydGVkJyk7CiAgbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIucmVnaXN0ZXIoJy9qcy9zdy5qcycpLnRoZW4oZnVuY3Rpb24gKHN3UmVnKSB7CiAgICBMb2cuaW5mbygiU2VydmljZSBXb3JrZXIgaXMgcmVnaXN0ZXJlZCAiLmNvbmNhdChKU09OLnN0cmluZ2lmeShzd1JlZykpKTsKICAgIHN3UmVnaXN0cmF0aW9uID0gc3dSZWc7CiAgICBpbml0VXNlckludGVyZmFjZSgpOwogIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgTG9nLmluZm8oIlNlcnZpY2UgV29ya2VyIEVycm9yICIuY29uY2F0KEpTT04uc3RyaW5naWZ5KGVycm9yKSkpOwogIH0pOwp9KTs="},{"version":3,"sources":["/Users/dduru/VSCode/OmarzeUI/src/router/util/include/background/service-worker/index.ts"],"names":[],"mappings":"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","sourcesContent":["\nimport { Log, Web, Util } from '@/components/util';\nimport setupSSE from '../sse';\n\n\nconst applicationServerPublicKey = process.env.VUE_APP_VAPID_PUB_KEY;\n\nlet isSubscribed: boolean = false;\nlet swRegistration: any = null;\n\nfunction urlB64ToUint8Array(base64String: string) {\n    const padding = '='.repeat((4 - base64String.length % 4) % 4);\n    const base64 = (base64String + padding)\n        .replace(/\\-/g, '+')\n        .replace(/_/g, '/');\n\n    const rawData = window.atob(base64);\n    const outputArray = new Uint8Array(rawData.length);\n\n    for (let i = 0; i < rawData.length; ++i) {\n        outputArray[i] = rawData.charCodeAt(i);\n    }\n\n    return outputArray;\n}\n\n\nfunction initUserInterface() {\n    // Set the initial subscription value\n    swRegistration\n    .pushManager\n    .getSubscription()\n    .then(\n        (subscription: any) => {\n            isSubscribed = !(subscription === null);\n\n            updateSubscriptionOnServer(subscription);\n\n            if (isSubscribed) {\n                Log.info('User IS subscribed.');\n            } else {\n                Log.info('User IS NOT subscribed.');\n                subscribeUser();\n            }\n        }\n    );\n}\n\n\nfunction subscribeUser() {\n    const applicationServerKey = urlB64ToUint8Array(applicationServerPublicKey);\n\n    swRegistration.pushManager.subscribe({\n        userVisibleOnly: true,\n        applicationServerKey,\n    })\n    .then(\n        (subscription: any) => {\n            Log.info('User is subscribed.');\n\n            updateSubscriptionOnServer(subscription);\n\n            isSubscribed = true;\n        }\n    )\n    .catch(\n        (error: any) => {\n            Log.info(`Failed to subscribe the user: ${JSON.stringify(error)}`);\n            setupSSE();\n        }\n    );\n}\n\n\nfunction updateSubscriptionOnServer(subscription: {endpoint: string, keys: any}) {\n    // TODO: Send subscription to application server\n\n    Log.info(`Subscription: ${JSON.stringify(subscription)}`);\n    subscription = Util.refresh(subscription);\n\n    if (subscription) {\n        Log.info('Subscription available. Calling Server.');\n        \n        // TODO: handle duplicate posting on server side.\n\n        Web.post(\n            '/api/v1/notification_subscription',\n\n            {\n                endpoint: subscription.endpoint,\n                publicKey: subscription.keys.p256dh,\n                authToken: subscription.keys.auth,\n            },\n\n            (response) => {\n                Log.info('Subscription successfully posted to server.');\n            },\n\n            (error) => {\n                Log.info('Subscription failed on posting to server.');\n                setupSSE();\n            }\n        );\n    } else {\n        Log.info('No subscription available');\n        setupSSE();\n    }\n}\n\n\n\n\n\nexport default () => {\n\n    Log.info('Service Worker and Push is supported');\n\n    navigator\n        .serviceWorker.register('/js/sw.js')\n        .then(\n            (swReg: ServiceWorkerRegistration) => {\n                Log.info(`Service Worker is registered ${JSON.stringify(swReg)}`);\n\n                swRegistration = swReg;\n                initUserInterface();\n            }\n        )\n        .catch(\n            (error: any) => {\n                Log.info(`Service Worker Error ${JSON.stringify(error)}`);\n            }\n        );\n\n};\n\n\n"],"sourceRoot":""}]}